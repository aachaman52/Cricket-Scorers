<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Cricket Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8; --accent: #3b82f6; --live: #22c55e; --break: #f59e0b; --finished: #ef4444; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; overflow-x: hidden; }
        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; position: relative; z-index: 10; }
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; animation: fadeOut 0.5s ease-out 2s forwards; }
        #splash img { width: 120px; height: 120px; margin-bottom: 20px; animation: bounce 1s infinite; }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .app-header { background: var(--card-bg); padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: 1px; color: white; flex: 1; }
        .live-badge { background: var(--live); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #match-list { padding: 10px; }
        .match-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #334155; cursor: pointer; transition: transform 0.2s; }
        .mc-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .mc-teams { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
        .mc-score { font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
        .mc-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-top: 10px; }
        #match-detail { display: none; padding: 10px; }
        .back-btn { background: none; border: none; color: var(--accent); font-weight: bold; cursor: pointer; font-size: 1.2rem; padding: 0; margin-right: 15px; display: flex; align-items: center;}
        .score-hero { background: linear-gradient(135deg, #1e40af, #1e3a8a); padding: 25px; border-radius: 16px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .hero-teams { font-size: 1.2rem; font-weight: 600; color: white; margin-bottom: 10px; }
        .hero-score { font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .hero-overs { font-size: 1.1rem; color: #bfdbfe; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-top: 5px; }
        .ball-row { display: flex; gap: 8px; justify-content: center; margin-top: 5px; flex-wrap: wrap; }
        .ball { width: 32px; height: 32px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: bold; border: 1px solid #475569; }
        .ball.wkt { background: var(--finished); border-color: var(--finished); }
        .ball.four { background: var(--accent); border-color: var(--accent); }
        .ball.six { background: var(--live); color: black; border-color: var(--live); }
        .card { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #334155; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #334155; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: var(--text-muted); transition: all 0.2s; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .bat-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .bat-table td { padding: 8px 0; border-bottom: 1px solid #334155; }
        .bat-name { font-weight: 600; }
        .bat-out { font-size: 0.8rem; color: var(--finished); display: block; }
        .bat-runs { text-align: right; font-weight: bold; color: var(--accent); }
        .loading { text-align: center; padding: 50px; color: var(--text-muted); }
    </style>
</head>
<body>
    <div id="splash"><img src="logo.png" alt="App Icon"><div style="color: var(--text-muted); font-size: 0.9rem;">Loading Cricket Viewer...</div></div>
    <div class="container">
        <header class="app-header">
            <button id="btn-back" class="back-btn hidden" onclick="goHome()">&#8592;</button>
            <div class="logo">CricViewer</div>
            <div class="live-badge">LIVE</div>
        </header>
        <div id="match-list"><div class="loading">Connecting...</div></div>
        <div id="match-detail"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCLJMN9v4XCM0Bfokue1sH7Mf4T0wVPKH8",
          authDomain: "aachman-studios.firebaseapp.com",
          databaseURL: "https://aachman-studios-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "aachman-studios",
          storageBucket: "aachman-studios.appspot.com",
          messagingSenderId: "917025025193",
          appId: "1:917025025193:web:c63c200922215e4b6e0db8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let allMatches = {}; let currentView = 'list'; let currentMatchId = null; let currentTab = 'live';

        onValue(ref(db, 'matches'), (snapshot) => {
            allMatches = snapshot.val() || {};
            render();
        });

        function render() {
            if (currentView === 'list') renderList();
            else if (currentView === 'detail' && currentMatchId) renderDetail(currentMatchId);
        }

        function renderList() {
            const listEl = document.getElementById('match-list');
            document.getElementById('match-detail').style.display = 'none';
            document.getElementById('btn-back').classList.add('hidden');
            listEl.style.display = 'block';
            const ids = Object.keys(allMatches).sort((a,b) => (allMatches[b].updatedAt||0) - (allMatches[a].updatedAt||0));
            if (ids.length === 0) { listEl.innerHTML = '<div class="loading">No matches available.</div>'; return; }
            listEl.innerHTML = ids.map(id => {
                const m = allMatches[id];
                const sc = m.score || {runs:0, wickets:0, balls:0};
                return `<div class="match-card" onclick="window.viewMatch('${id}')">
                    <div class="mc-header"><span>${m.tournament||'Match'}</span><span>${m.meta?.type||''}</span></div>
                    <div class="mc-teams">${m.teams?.a} vs ${m.teams?.b}</div>
                    <div class="mc-score">${sc.runs}/${sc.wickets} <span style="font-size:0.9rem;color:#94a3b8">(${ballToOver(sc.balls)})</span></div>
                    <div class="mc-status ${m.status==='LIVE'?'st-live':'st-finished'}">${m.status}</div>
                </div>`;
            }).join('');
        }

        function renderDetail(id) {
            const m = allMatches[id];
            if (!m) return goHome();
            const container = document.getElementById('match-detail');
            document.getElementById('match-list').style.display = 'none';
            document.getElementById('btn-back').classList.remove('hidden');
            container.style.display = 'block';

            const sc = m.score || { runs: 0, wickets: 0, balls: 0 };
            
            // Build Scorecards
            const buildInnings = (innName, teamName, runs, wkts, balls, bats) => {
                let rows = bats ? bats.map(b => `<tr>
                    <td>
                        <div class="bat-name" style="color: ${b.onStrike ? '#4ade80' : 'inherit'}">
                            ${b.n} ${b.onStrike ? 'üèè' : ''} ${b.onNonStrike ? '(ns)' : ''}
                        </div>
                        <span class="bat-out">${b.out ? (b.how || 'out') : 'not out'}</span>
                    </td>
                    <td class="bat-runs">${b.r} (${b.b})</td>
                </tr>`).join('') : '<tr><td colspan="2" style="text-align:center;color:#666">No data</td></tr>';
                return `<div class="card">
                    <div style="font-weight:bold; color:var(--accent); margin-bottom:5px;">${innName}: ${teamName}</div>
                    <div style="font-size:1.5rem; font-weight:800; margin-bottom:10px;">${runs}/${wkts} <span style="font-size:1rem;color:#999">(${ballToOver(balls)} ov)</span></div>
                    <table class="bat-table">${rows}</table>
                </div>`;
            };

            let scorecardHtml = "";
            if(m.innData) m.innData.forEach((inn, idx) => { scorecardHtml += buildInnings(`Innings ${idx+1}`, inn.team, inn.score.runs, inn.score.wickets, inn.score.balls, inn.bats); });
            if(m.currentInnings) {
                let name = m.innings === 1 ? "Innings 1" : "Innings 2";
                scorecardHtml += buildInnings(name, m.currentInnings.team, sc.runs, sc.wickets, sc.balls, m.currentInnings.bats);
            }

            // üî¥ ACTIVE BOWLER LOGIC
            let activeBowlerHtml = "";
            if (m.currentInnings && m.currentInnings.bowl && m.currentInnings.activeBowlerIndex !== undefined) {
                const b = m.currentInnings.bowl[m.currentInnings.activeBowlerIndex];
                if(b) {
                    activeBowlerHtml = `
                    <div class="card">
                        <div class="stat-label" style="margin-bottom:5px;">BOWLING NOW</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold; font-size:1.1rem; color:#fff;">${b.n}</span>
                            <span style="color:var(--gold); font-weight:bold;">${b.w}-${b.r} <span style="font-size:0.8rem;color:#999">(${ballToOver(b.b)})</span></span>
                        </div>
                    </div>`;
                }
            }

            // üî¥ FIX: SAFELY GET 'THIS OVER' ARRAY (Handles Firebase object/array conversion)
            let thisOvArr = [];
            if (m.thisOv) {
                 thisOvArr = Array.isArray(m.thisOv) ? m.thisOv : Object.values(m.thisOv);
            }

            container.innerHTML = `
                <div class="score-hero">
                    <div class="hero-teams">${m.teams?.a} vs ${m.teams?.b}</div>
                    <div class="hero-score">${sc.runs}/${sc.wickets}</div>
                    <div class="hero-overs">(${ballToOver(sc.balls)} Overs)</div>
                    <div class="hero-status" style="color:${m.status==='LIVE'?'#4ade80':'#fff'}">${m.status}</div>
                </div>
                <div class="tabs">
                    <div class="tab ${currentTab === 'live' ? 'active' : ''}" onclick="window.switchTab('live')">Live</div>
                    <div class="tab ${currentTab === 'scorecard' ? 'active' : ''}" onclick="window.switchTab('scorecard')">Scorecard</div>
                    <div class="tab ${currentTab === 'analysis' ? 'active' : ''}" onclick="window.switchTab('analysis')">Analysis</div>
                </div>
                
                <div class="tab-content ${currentTab === 'live' ? 'active' : ''}">
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-label">CRR</div><div class="stat-val">${m.analysis?.crr || '0.0'}</div></div>
                        ${m.target ? `<div class="stat-box"><div class="stat-label">Target</div><div class="stat-val">${m.target}</div></div>` : ''}
                    </div>
                    
                    ${activeBowlerHtml}

                    <div class="card">
                        <div class="stat-label" style="margin-bottom:10px;">CURRENT OVER</div>
                        <div class="ball-row">
                            ${(thisOvArr.length > 0) ? thisOvArr.map(b=>`<div class="ball ${b=='W'?'wkt':b==4?'four':b==6?'six':''}">${b}</div>`).join('') : '<span style="color:#666; font-size:0.8rem">No balls bowled in this over yet</span>'}
                        </div>
                    </div>

                    <div class="card" style="text-align:center; color:#94a3b8; font-size:0.8rem;">
                        <p>üèü ${m.meta?.ground || 'Ground info not available'}</p>
                        <p>üìç ${m.meta?.city || 'City info not available'}</p>
                    </div>
                </div>

                <div class="tab-content ${currentTab === 'scorecard' ? 'active' : ''}">
                    ${scorecardHtml || '<div class="card" style="text-align:center">No scorecard data yet</div>'}
                </div>

                <div class="tab-content ${currentTab === 'analysis' ? 'active' : ''}">
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-label">Proj. Score</div><div class="stat-val">${m.analysis?.projScore || '-'}</div></div>
                        <div class="stat-box"><div class="stat-label">Req. Rate</div><div class="stat-val" style="color:#f59e0b">${m.analysis?.rrr || '-'}</div></div>
                        <div class="stat-box"><div class="stat-label">Balls Rem.</div><div class="stat-val">${m.analysis?.remBalls || 0}</div></div>
                        <div class="stat-box"><div class="stat-label">Wickets Left</div><div class="stat-val">${m.analysis?.remWkts || 10}</div></div>
                    </div>
                    <div class="card" style="height:300px;"><canvas id="worm"></canvas></div>
                </div>
            `;
            
            // Render Worm if on analysis tab
            if(currentTab === 'analysis') {
                setTimeout(() => {
                    let ctx = document.getElementById('worm');
                    if(ctx) {
                        ctx = ctx.getContext('2d');
                        if(window.viewWorm) window.viewWorm.destroy();
                        let labels = Array.from({length: (m.meta?.overs || 20) + 1}, (_, i) => i);
                        let w1 = (m.worm && m.worm[0]) ? m.worm[0] : [];
                        let w2 = (m.worm && m.worm[1]) ? m.worm[1] : [];
                        
                        window.viewWorm = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    { label: m.teams?.a || 'Inn 1', data: w1, borderColor: '#3b82f6', fill: false },
                                    { label: m.teams?.b || 'Inn 2', data: w2, borderColor: '#f59e0b', fill: false }
                                ]
                            },
                            options: { maintainAspectRatio: false, responsive: true }
                        });
                    }
                }, 100);
            }
        }

        window.viewMatch = (id) => { currentMatchId = id; currentView = 'detail'; render(); };
        window.goHome = () => { currentMatchId = null; currentView = 'list'; render(); };
        window.switchTab = (t) => { currentTab = t; render(); };
        function ballToOver(b) { return Math.floor(b/6) + "." + (b%6); }
    </script>
</body>
</html>