<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Scorer: Master</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --primary: #3b82f6; --accent: #22c55e; --danger: #ef4444; --gold: #f59e0b; --text: #f8fafc; --muted: #94a3b8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; user-select: none; }
        .container { max-width: 600px; margin: auto; padding: 10px; position: relative; z-index: 2; }
        #splash { position: fixed; inset: 0; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 99999; }
        .splash-box { text-align: center; color: white; }
        .card { background: var(--panel); padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #334155; }
        .nav { display: flex; background: var(--panel); padding: 5px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #334155; }
        .nav-item { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: var(--muted); font-weight: bold; font-size: 0.85rem; }
        .nav-item.active { background: var(--primary); color: white; border-radius: 6px; }
        .section { display: none; }
        .section.active { display: block; }
        .hidden { display: none !important; }
        .score-box { text-align: center; background: linear-gradient(135deg, #1e40af, #1e3a8a); padding: 20px; border-radius: 12px; margin-top: 10px; margin-bottom: 10px; }
        .big-score { font-size: 3.5rem; font-weight: 800; margin: 5px 0; line-height: 1; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; color: #bfdbfe; margin-top: 5px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .stat-item { background: #0f172a; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #334155; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--gold); }
        .stat-lbl { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; }
        .win-prob-bar { height: 12px; background: var(--danger); border-radius: 6px; margin: 15px 0; display: flex; overflow: hidden; }
        .win-prob-fill { background: var(--accent); height: 100%; transition: width 0.5s; }
        .controls { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--panel); padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; z-index: 100; max-width: 600px; left: 50%; transform: translateX(-50%); border-top: 1px solid #334155; }
        button { border: none; border-radius: 6px; padding: 12px 0; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; }
        input, select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #475569; color: white; border-radius: 5px; box-sizing: border-box; margin-bottom: 8px; font-size: 1rem; }
        #tv-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); text-align: center; padding: 20px; }
        .tv-card { background: #1e293b; padding: 30px; border-radius: 15px; border: 2px solid var(--gold); width:80%; max-width:300px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; }
        .modal-box { background: var(--panel); padding: 20px; width: 90%; max-width: 350px; border-radius: 10px; border: 1px solid #475569; }
    </style>
</head>
<body onload="init()">
    <div id="splash"><div class="splash-box"><h1>Pro Scorer</h1><p>Loading...</p></div></div>
    
    <div id="tv-overlay"><div class="tv-card"><div id="tv-icon" style="font-size:3rem;">üèÜ</div><div id="tv-title" style="color:var(--gold); font-size:1.5rem; font-weight:bold;">RESULT</div><div id="tv-msg"></div><button onclick="closeOverlay()" style="width:100%; background:var(--primary); margin-top:10px;">CONTINUE</button></div></div>

    <div id="view-home" class="container section active">
        <div class="nav">
            <div class="nav-item active" onclick="tab('home','quick', this)">QUICK</div>
            <div class="nav-item" onclick="tab('home','tourn', this)">TOURNAMENT</div>
            <div class="nav-item" onclick="tab('home','hist', this)">HISTORY</div>
        </div>
        <div id="home-quick" class="sub-sec">
            <div class="card">
                <h2 style="color:var(--primary); margin-top:0; text-align:center;">MATCH SETUP</h2>
                <input id="q-ground" placeholder="Ground / Stadium">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input id="q-city" placeholder="City">
                    <select id="q-type"><option>T20</option><option>ODI</option><option>Test</option></select>
                </div>
                <hr style="border-color:#334155; margin:15px 0;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input id="q-t1" placeholder="Team A (Bat)">
                    <input id="q-t2" placeholder="Team B (Bowl)">
                    <input type="number" id="q-ov" value="10" placeholder="Overs">
                    <input type="number" id="q-pl" value="11" placeholder="Players">
                </div>
                <input id="q-s" placeholder="Striker">
                <input id="q-ns" placeholder="Non-Striker">
                <input id="q-b" placeholder="Bowler">
                <label style="display:flex; align-items:center; margin-top:10px; font-size:0.9rem;"><input type="checkbox" id="q-lms" style="width:auto; margin-right:8px;"> Last Man Standing</label>
                <button onclick="startQuick()" style="width:100%; background:var(--accent); margin-top:15px;">START MATCH</button>
            </div>
        </div>
        <div id="home-tourn" class="sub-sec hidden"><div class="card"><p style="text-align:center">Tournament Mode Active</p></div></div>
        <div id="home-hist" class="sub-sec hidden"><div id="hist-list"></div><button onclick="wipeHist()" style="width:100%; background:var(--danger); margin-top:20px;">CLEAR DATA</button></div>
    </div>

    <div id="view-game" class="container section">
        <div class="nav">
            <div class="nav-item active" onclick="gmTab('live', this)">LIVE</div>
            <div class="nav-item" onclick="gmTab('card', this)">CARD</div>
            <div class="nav-item" onclick="gmTab('analysis', this)">ANALYSIS</div>
            <div class="nav-item" onclick="openActions()" style="color:var(--gold)">ACTIONS</div>
        </div>
        <div id="gm-live" class="gm-sub">
            <div class="score-box">
                <div id="ui-teams" style="font-weight:bold; letter-spacing:1px; color:#fff;">-</div>
                <div class="big-score"><span id="ui-r">0</span>/<span id="ui-w">0</span></div>
                <div class="stat-row"><span>Ov: <span id="ui-ov">0.0</span></span><span>CRR: <span id="ui-crr">0.0</span></span></div>
                <div id="ui-target" class="hidden" style="margin-top:5px; color:var(--gold); font-weight:bold;">Target: 0</div>
            </div>
            <div class="card"><div id="ui-bats"></div></div>
            <div class="card"><div id="ui-bowl"></div><div id="ui-over" style="display:flex;gap:5px;margin-top:5px;overflow-x:auto;"></div></div>
        </div>
        <div id="gm-card" class="gm-sub hidden"><div class="card"><div id="full-card"></div></div></div>
        <div id="gm-analysis" class="gm-sub hidden">
            <div class="card">
                <div class="stat-grid">
                    <div class="stat-item"><div class="stat-val" id="an-rrr">-</div><div class="stat-lbl">Req. Rate</div></div>
                    <div class="stat-item"><div class="stat-val" id="an-proj">0</div><div class="stat-lbl">Proj. Score</div></div>
                    <div class="stat-item"><div class="stat-val" id="an-rem">0</div><div class="stat-lbl">Balls Rem.</div></div>
                    <div class="stat-item"><div class="stat-val" id="an-wkt">10</div><div class="stat-lbl">Wickets Hand</div></div>
                </div>
                <div style="height:250px;"><canvas id="worm"></canvas></div>
            </div>
        </div>
        <div class="controls" id="controls">
            <button style="background:#334155;" onclick="run(0)">0</button>
            <button style="background:#334155;" onclick="run(1)">1</button>
            <button style="background:#334155;" onclick="run(2)">2</button>
            <button style="background:var(--primary);" onclick="run(4)">4</button>
            <button style="background:var(--gold); color:black;" onclick="run(6)">6</button>
            <button style="background:var(--accent); color:black;" onclick="mod('wd')">WD</button>
            <button style="background:var(--accent); color:black;" onclick="mod('nb')">NB</button>
            <button style="background:var(--danger);" onclick="wkt()">OUT</button>
            <button style="background:#475569;" onclick="undo()">UNDO</button>
            <button style="background:#0f172a;" onclick="openActions()">‚ò∞</button>
        </div>
    </div>

    <div id="m-inn-setup" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--gold); text-align:center;">SECOND INNINGS SETUP</h3>
            <label style="font-size:0.8rem; color:#ccc;">Batting Team (Chasing)</label>
            <input id="i2-s" placeholder="Striker Name">
            <input id="i2-ns" placeholder="Non-Striker Name">
            <label style="font-size:0.8rem; color:#ccc;">Bowling Team (Defending)</label>
            <input id="i2-b" placeholder="Opening Bowler">
            <button onclick="startInn2()" style="width:100%; background:var(--accent); margin-top:10px;">START CHASE</button>
        </div>
    </div>

    <div id="m-wkt" class="modal"><div class="modal-box"><h3>WICKET</h3><select id="w-type" onchange="updateWktModal()"><option value="Bowled">Bowled</option><option value="Caught">Caught</option><option value="Run Out">Run Out</option><option value="LBW">LBW</option><option value="Stumped">Stumped</option></select><div id="div-who" class="hidden"><select id="w-who"><option value="s">Striker</option><option value="ns">Non-Striker</option></select></div><div id="div-fielder" class="hidden"><input id="w-fielder" placeholder="Fielder Name"></div><input id="w-new" placeholder="Next Batsman"><button onclick="confWkt()" style="width:100%; background:var(--danger); margin-top:10px;">CONFIRM</button><button onclick="closeMod('m-wkt')" style="width:100%; background:transparent;">CANCEL</button></div></div>
    <div id="m-wd" class="modal"><div class="modal-box"><h3>Wide</h3><button onclick="ex('WD',0)" style="width:100%; background:var(--primary);">Confirm (+1)</button><button onclick="closeMod('m-wd')" style="width:100%; background:transparent;">Cancel</button></div></div>
    <div id="m-nb" class="modal"><div class="modal-box"><h3>No Ball</h3><div style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px;"><button onclick="ex('NB',0)" style="background:#334155;">0</button><button onclick="ex('NB',1)" style="background:#334155;">1</button><button onclick="ex('NB',4)" style="background:var(--primary);">4</button><button onclick="ex('NB',6)" style="background:var(--gold); color:black;">6</button></div><button onclick="closeMod('m-nb')" style="width:100%; background:transparent;">Cancel</button></div></div>
    <div id="m-bowl" class="modal"><div class="modal-box"><h3>End Over</h3><input id="b-next" placeholder="Next Bowler"><button onclick="confBowl()" style="width:100%; background:var(--primary);">Start</button></div></div>
    <div id="m-act" class="modal"><div class="modal-box"><h3>Actions</h3><button onclick="manualEndInnings()" style="width:100%; background:#334155; margin-bottom:10px;">End Innings</button><button onclick="finish('Abandoned')" style="width:100%; background:#334155; margin-bottom:10px;">Abandon</button><button onclick="quitGame()" style="width:100%; background:var(--danger);">Exit</button><button onclick="closeMod('m-act')" style="width:100%; background:transparent;">Cancel</button></div></div>

<script>
const STATUS = { LIVE: 'LIVE', BREAK: 'BREAK', FINISHED: 'FINISHED' };
let g = {}; let mode = 'quick'; window.MATCH_ID = null; 

function init() { renderHist(); setTimeout(() => { document.getElementById("splash").style.display = "none"; }, 1500); }
function tab(area, t, el) { document.querySelectorAll('.sub-sec').forEach(e => e.classList.add('hidden')); document.getElementById(area+'-'+t).classList.remove('hidden'); document.querySelectorAll('#view-home .nav-item').forEach(e => e.classList.remove('active')); if(el) el.classList.add('active'); }
function gmTab(t, el) { document.querySelectorAll('.gm-sub').forEach(e => e.classList.add('hidden')); document.getElementById('gm-'+t).classList.remove('hidden'); document.querySelectorAll('#view-game .nav-item').forEach(e => e.classList.remove('active')); if(el) el.classList.add('active'); if(t==='card') renderCard(); if(t==='analysis') renderAnalysis(); if(t==='live') updateUI(); }

function startQuick() {
    mode = 'quick';
    initGame({
        t1: document.getElementById('q-t1').value || "Home",
        t2: document.getElementById('q-t2').value || "Away",
        ov: parseInt(document.getElementById('q-ov').value) || 10,
        pl: parseInt(document.getElementById('q-pl').value) || 11,
        lms: document.getElementById('q-lms').checked,
        s: document.getElementById('q-s').value || "Striker",
        ns: document.getElementById('q-ns').value || "NonStriker",
        b: document.getElementById('q-b').value || "Bowler",
        ground: document.getElementById('q-ground').value || "Local Ground",
        city: document.getElementById('q-city').value || "Local City",
        type: document.getElementById('q-type').value || "Friendly"
    });
}

function initGame(cfg) {
    window.MATCH_ID = "match_" + Date.now();
    g = { meta: cfg, status: STATUS.LIVE, inn:1, target:null, sc:{r:0,w:0,b:0}, bats:[{n:cfg.s||"P1",r:0,b:0,out:false},{n:cfg.ns||"P2",r:0,b:0,out:false}], bowl:[{n:cfg.b||"B1",r:0,w:0,b:0}], s:0, ns:1, cb:0, thisOv:[], hist:[], inn1:null, worm:[[],[]] };
    document.getElementById('view-home').classList.remove('active'); document.getElementById('view-game').classList.add('active'); updateUI();
}

function run(r) { if(g.status !== STATUS.LIVE) return; save(); g.sc.r+=r; g.sc.b++; g.bats[g.s].r+=r; g.bats[g.s].b++; g.bowl[g.cb].r+=r; g.bowl[g.cb].b++; g.thisOv.push(r); if(r%2!==0 && !isLastMan()) swap(); if(checkFlow()) return; checkOv(); updateUI(); }
function ex(t,r) { if(g.status !== STATUS.LIVE) return; closeMod('m-wd'); closeMod('m-nb'); save(); if(t==='WD') { g.sc.r++; g.bowl[g.cb].r++; } else { g.sc.r+=(1+r); g.bowl[g.cb].r+=(1+r); g.bats[g.s].r+=r; g.bats[g.s].b++; if(r%2!==0 && !isLastMan()) swap(); } g.thisOv.push(t+(r>0?'+'+r:'')); if(checkFlow()) return; updateUI(); }

function wkt() { if(g.status === STATUS.LIVE) { document.getElementById('w-type').value = "Bowled"; updateWktModal(); mod('wkt'); } }
function updateWktModal() {
    const type = document.getElementById('w-type').value;
    document.getElementById('div-who').classList.toggle('hidden', type !== 'Run Out');
    document.getElementById('div-fielder').classList.toggle('hidden', !['Caught', 'Run Out', 'Stumped'].includes(type));
}
function confWkt() {
    closeMod('m-wkt'); save();
    let type = document.getElementById('w-type').value; 
    let whoVal = document.getElementById('w-who').value;
    let fielder = document.getElementById('w-fielder').value.trim() || "Fielder";
    let bowlerName = g.bowl[g.cb].n;
    let v = (type === 'Run Out' && whoVal === 'ns') ? g.ns : g.s;

    let howText = "";
    if (type === 'Bowled') howText = `b ${bowlerName}`;
    else if (type === 'LBW') howText = `lbw b ${bowlerName}`;
    else if (type === 'Caught') howText = `c ${fielder} b ${bowlerName}`;
    else if (type === 'Stumped') howText = `st ${fielder} b ${bowlerName}`;
    else if (type === 'Run Out') howText = `run out (${fielder})`;
    else howText = type;

    g.bats[v].out = true; g.bats[v].how = howText; 
    g.sc.w++; g.sc.b++; g.thisOv.push('W'); g.bowl[g.cb].b++; 
    if(type !== 'Run Out') g.bowl[g.cb].w++;
    
    let max = g.meta.lms ? g.meta.pl : g.meta.pl - 1;
    if(g.sc.w < max) {
        let n = document.getElementById('w-new').value || "Bat " + (g.bats.length + 1);
        g.bats.push({n:n, r:0, b:0, out:false});
        if (v === g.s) g.s = g.bats.length - 1; else g.ns = g.bats.length - 1;
    } else { if (v === g.s) g.s = -1; else g.ns = -1; }
    
    document.getElementById('w-new').value = ''; document.getElementById('w-fielder').value = '';
    if(checkFlow()) return; checkOv(); updateUI();
}

function checkFlow() { if(g.status === STATUS.FINISHED) return true; let max = g.meta.lms ? g.meta.pl : g.meta.pl - 1; if (g.inn === 2 && g.target && g.sc.r >= g.target) { finish("Target Chased"); return true; } if (g.sc.w >= max) { if (g.inn === 1) endInn(); else finish("All Out"); return true; } return false; }
function isLastMan() { return g.meta.lms && g.ns === -1; }
function swap() { if (g.meta.lms && g.ns === -1) return; [g.s, g.ns] = [g.ns, g.s]; }
function checkOv() { if(g.sc.b % 6 === 0 && g.sc.b > 0) { if(!g.worm[g.inn - 1]) g.worm[g.inn - 1] = []; g.worm[g.inn - 1].push(g.sc.r); swap(); if(Math.floor(g.sc.b / 6) >= g.meta.ov) { endInn(); } else { mod('bowl'); } } }
function confBowl() { let n = document.getElementById('b-next').value; document.getElementById('b-next').value = ""; closeMod('m-bowl'); let ex = g.bowl.findIndex(b => b.n === n); if(ex === -1) { g.bowl.push({n:n, r:0, w:0, b:0}); g.cb = g.bowl.length - 1; } else { g.cb = ex; } g.thisOv = []; updateUI(); }
function manualEndInnings() { closeMod('m-act'); endInn(); }

function endInn() {
    if(g.status === STATUS.FINISHED) return;
    if(!g.worm[g.inn - 1]) g.worm[g.inn - 1] = [];
    g.worm[g.inn - 1].push(g.sc.r);

    if(g.inn === 1) {
        g.inn1 = { t: g.meta.t1, sc: {...g.sc}, bats: JSON.parse(JSON.stringify(g.bats)), bowl: JSON.parse(JSON.stringify(g.bowl)) };
        g.target = g.sc.r + 1;
        g.inn = 2;
        g.sc = {r:0, w:0, b:0};
        let t = g.meta.t1; g.meta.t1 = g.meta.t2; g.meta.t2 = t;
        g.bats = []; g.bowl = []; g.s = 0; g.ns = 1; g.cb = 0; g.thisOv = [];
        g.status = STATUS.BREAK;
        if (window.pushLive) pushLive(g);
        showOverlay("INNINGS BREAK", `Target: ${g.target}`, "üèè", () => { document.getElementById('m-inn-setup').style.display = 'flex'; });
    } else {
        finish("Overs/AllOut");
    }
}

function startInn2() {
    const sName = document.getElementById('i2-s').value || "Striker";
    const nsName = document.getElementById('i2-ns').value || "Non-Striker";
    const bName = document.getElementById('i2-b').value || "Bowler";
    g.bats = [{n: sName, r:0, b:0, out:false}, {n: nsName, r:0, b:0, out:false}];
    g.bowl = [{n: bName, r:0, w:0, b:0}];
    g.s = 0; g.ns = 1; g.cb = 0;
    g.status = STATUS.LIVE;
    document.getElementById('m-inn-setup').style.display = 'none';
    updateUI();
}

function closeOverlay() { document.getElementById('tv-overlay').style.display = 'none'; if(overlayCallback) overlayCallback(); overlayCallback = null; }
function finish(reason) { if(g.status === STATUS.FINISHED) return; closeMod('m-act'); g.status = STATUS.FINISHED; if(!g.worm[g.inn - 1]) g.worm[g.inn - 1] = []; g.worm[g.inn - 1].push(g.sc.r); let res = (reason === "Abandoned") ? "Abandoned" : (g.sc.r >= g.target) ? g.meta.t1 + " Won" : g.meta.t2 + " Won"; updateUI(); showOverlay("MATCH OVER", res, "üèÜ", () => { quitGame(); }); }
function quitGame() { document.getElementById('view-game').classList.remove('active'); document.getElementById('view-home').classList.add('active'); window.MATCH_ID = null; }
function updateUI() { document.getElementById('ui-teams').innerText = g.meta.t1 + " vs " + g.meta.t2; document.getElementById('ui-r').innerText = g.sc.r; document.getElementById('ui-w').innerText = g.sc.w; document.getElementById('ui-ov').innerText = Math.floor(g.sc.b / 6) + "." + (g.sc.b % 6); document.getElementById('ui-crr').innerText = g.sc.b > 0 ? (g.sc.r / (g.sc.b / 6)).toFixed(1) : "0.0"; if(g.inn === 2) { document.getElementById('ui-target').classList.remove('hidden'); document.getElementById('ui-target').innerText = "Target: " + g.target; } let bh = ""; const rb = (i, s) => { let b = g.bats[i]; bh += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px; color:${s ? 'var(--accent)' : '#ccc'}"><span>${b.n}${s ? '*' : ''}</span><span>${b.r}(${b.b})</span></div>`; }; if(g.s !== -1) rb(g.s, true); if(g.ns !== -1) rb(g.ns, false); document.getElementById('ui-bats').innerHTML = bh; let bw = g.bowl[g.cb]; document.getElementById('ui-bowl').innerHTML = `<div style="display:flex; justify-content:space-between; padding:5px;"><span>${bw.n}</span><span>${bw.w}-${bw.r}</span></div>`; document.getElementById('ui-over').innerHTML = g.thisOv.map(x => `<span style="background:#444;padding:5px;border-radius:50%;min-width:20px;text-align:center;">${x}</span>`).join(''); let isLive = (g.status === STATUS.LIVE); document.getElementById('controls').style.opacity = isLive ? "1" : "0.5"; document.getElementById('controls').style.pointerEvents = isLive ? "auto" : "none"; if(!document.getElementById('gm-analysis').classList.contains('hidden')) renderAnalysis(); if (window.pushLive) pushLive(g); }
function renderAnalysis() { 
    let remBalls = (g.meta.ov * 6) - g.sc.b;
    document.getElementById('an-rem').innerText = Math.max(0, remBalls);
    let wLeft = (g.meta.lms ? g.meta.pl : g.meta.pl - 1) - g.sc.w;
    document.getElementById('an-wkt').innerText = Math.max(0, wLeft);
    let proj = g.sc.b > 0 ? Math.floor((g.sc.r / g.sc.b) * (g.meta.ov * 6)) : 0;
    if (g.inn === 1) { document.getElementById('an-proj').innerText = proj; document.getElementById('an-rrr').innerText = "-"; } else { document.getElementById('an-proj').innerText = "-"; let remRuns = g.target - g.sc.r; let rrr = remBalls > 0 ? (remRuns / remBalls * 6).toFixed(2) : "0.00"; document.getElementById('an-rrr').innerText = rrr; }
    let ctx = document.getElementById('worm').getContext('2d'); if(window.wc) window.wc.destroy(); if(!g.worm[0]) g.worm[0] = []; if(!g.worm[1]) g.worm[1] = []; let labels = Array.from({length: g.meta.ov + 1}, (_, i) => i); window.wc = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Inn1', data: g.worm[0], borderColor: '#3b82f6', fill: false }, { label: 'Inn2', data: g.worm[1], borderColor: '#f59e0b', fill: false } ] }, options: { maintainAspectRatio: false } });
}
function renderCard() { 
    let h = ""; const tbl = (inn, name) => { if(!inn) return ""; let t = `<h3 style='color:var(--gold); margin-top:20px'>${name} (${inn.sc.r}/${inn.sc.w})</h3><table>`; inn.bats.forEach(b => { let outTxt = b.out ? `<span style='color:var(--danger); font-size:0.8rem;'>${b.how || 'out'}</span>` : "<span style='color:var(--accent);'>not out</span>"; t += `<tr><td>${b.n}<br>${outTxt}</td><td style='text-align:right'><b>${b.r}</b> (${b.b})</td></tr>`; }); return t + "</table>"; }; if (g.inn === 1) { h += tbl(g, g.meta.t1); } else { h += tbl(g.inn1, g.inn1.t); h += tbl(g, g.meta.t1); } document.getElementById('full-card').innerHTML = h;
}
function save() { let s = JSON.parse(JSON.stringify(g)); delete s.hist; g.hist.push(JSON.stringify(s)); }
function undo() { if(g.status !== STATUS.LIVE) return; if(g.hist.length) { let h = g.hist; g = JSON.parse(h.pop()); g.hist = h; updateUI(); } }
function mod(type) { if (g.status !== STATUS.LIVE && type !== 'act') return; document.getElementById('m-' + type).style.display = 'flex'; }
function closeMod(id) { document.getElementById(id).style.display = 'none'; }
function renderHist() { document.getElementById('hist-list').innerHTML = (JSON.parse(localStorage.getItem('hist') || '[]')).map(x => `<div class=\"card\"><b>${x.res}</b><br><small>${x.date}</small></div>`).join(''); }
function wipeHist() { localStorage.removeItem('hist'); renderHist(); }
function openActions() { document.getElementById('m-act').style.display = 'flex'; }
</script>

<script type="module">
// üî¥ FIXED VERSION
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCLJMN9v4XCM0Bfokue1sH7Mf4T0wVPKH8",
  authDomain: "aachman-studios.firebaseapp.com",
  databaseURL: "https://aachman-studios-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "aachman-studios",
  storageBucket: "aachman-studios.appspot.com",
  messagingSenderId: "917025025193",
  appId: "1:917025025193:web:c63c200922215e4b6e0db8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.pushLive = function(g) {
  if (!g || !g.sc || !window.MATCH_ID) return;

  const balls = Math.max(1, g.sc.b);
  const crr = (g.sc.r / (balls / 6)).toFixed(2);
  let rrr = null;
  if(g.inn === 2 && g.target) {
     const remBalls = (g.meta.ov * 6) - g.sc.b;
     const remRuns = g.target - g.sc.r;
     rrr = remBalls > 0 ? (remRuns / (remBalls/6)).toFixed(2) : "0.00";
  }
  
  // üî¥ CALCULATE PROJ SCORE HERE
  const projScore = g.inn === 1 ? Math.ceil((g.sc.r / balls) * (g.meta.ov * 6)) : null;

  const viewerBats = g.bats.map((b, i) => ({
      ...b,
      onStrike: (i === g.s),
      onNonStrike: (i === g.ns)
  }));

  set(ref(db, "matches/" + window.MATCH_ID), {
    status: g.status,
    tournament: g.meta.tournament || "Quick Match",
    teams: { a: g.meta.t1, b: g.meta.t2 },
    score: { runs: g.sc.r, wickets: g.sc.w, balls: g.sc.b },
    innings: g.inn,
    target: g.target || null,
    currentInnings: { team: g.meta.t1, bats: viewerBats, bowl: g.bowl, activeBowlerIndex: g.cb },
    innData: g.inn1 ? [{ team: g.inn1.t, score: g.inn1.sc, bats: g.inn1.bats, bowl: g.inn1.bowl }] : [],
    worm: g.worm,
    thisOv: g.thisOv,
    analysis: { 
        crr: crr, 
        rrr: rrr, 
        remBalls: (g.meta.ov * 6) - g.sc.b, 
        remWkts: (g.meta.lms ? g.meta.pl : g.meta.pl - 1) - g.sc.w,
        projScore: projScore // üî¥ SENDING PROJ SCORE
    },
    meta: { ground: g.meta.ground, city: g.meta.city, type: g.meta.type, overs: g.meta.ov },
    updatedAt: Date.now()
  }).catch(e => console.error("Push Error:", e));
};
</script>
</body>
</html>